<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>像对选择算法设计文档</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --accent-color: #3b82f6;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 60px 20px;
            text-align: center;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }

        .card h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .card h3 {
            color: var(--secondary-color);
            margin: 20px 0 10px 0;
            font-size: 1.2rem;
        }

        .highlight-box {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin: 20px 0;
        }

        .highlight-box.success {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-left-color: var(--success-color);
        }

        .highlight-box.warning {
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            border-left-color: var(--warning-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f1f5f9;
        }

        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            margin: 15px 0;
        }

        .code-block .keyword {
            color: #c084fc;
        }

        .code-block .comment {
            color: #6b7280;
        }

        .code-block .string {
            color: #86efac;
        }

        .code-block .number {
            color: #fcd34d;
        }

        .flowchart {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 30px 0;
        }

        .flow-step {
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 20px 30px;
            margin: 10px 0;
            min-width: 300px;
            text-align: center;
            position: relative;
        }

        .flow-step.highlight {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border-width: 3px;
        }

        .flow-step::after {
            content: '';
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 12px solid var(--primary-color);
        }

        .flow-step:last-child::after {
            display: none;
        }

        .flow-step h4 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .flow-step p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .metric-comparison {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }

        .metric-item {
            text-align: center;
            padding: 20px;
        }

        .metric-item .before {
            color: var(--error-color);
            font-size: 1.5rem;
            font-weight: bold;
        }

        .metric-item .after {
            color: var(--success-color);
            font-size: 2rem;
            font-weight: bold;
        }

        .metric-item .arrow {
            font-size: 1.5rem;
            margin: 0 10px;
            color: var(--text-secondary);
        }

        .progress-bar {
            background: #e2e8f0;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: width 0.5s ease;
        }

        .formula {
            background: #f8fafc;
            border: 1px solid var(--border-color);
            padding: 15px 20px;
            border-radius: 8px;
            font-family: 'Times New Roman', serif;
            font-size: 1.1rem;
            text-align: center;
            margin: 15px 0;
        }

        .tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            margin: 2px;
        }

        .tag.primary {
            background: #dbeafe;
            color: var(--primary-color);
        }

        .tag.success {
            background: #dcfce7;
            color: #16a34a;
        }

        .tag.warning {
            background: #fef3c7;
            color: #d97706;
        }

        ul, ol {
            margin: 15px 0 15px 30px;
        }

        li {
            margin: 8px 0;
        }

        .two-column {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }

        footer {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            .two-column {
                grid-template-columns: 1fr;
            }

            .flow-step {
                min-width: 250px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>像对选择算法设计文档</h1>
        <p>Pair Selection Algorithm for Photogrammetric Image Matching</p>
        <p style="margin-top: 15px; font-size: 0.9rem;">Version 2.0 | 2024</p>
    </header>

    <div class="container">
        <!-- 概述 -->
        <div class="card">
            <h2>1. 算法概述</h2>
            <p>本算法用于从摄影测量影像集中选择最优的影像对，用于密集匹配(MVS)和光束法平差(BA)。算法基于共视性数据，结合多种特征进行智能选择。</p>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="value">81.3%</div>
                    <div class="label">匹配精度</div>
                </div>
                <div class="stat-card">
                    <div class="value">198</div>
                    <div class="label">目标像对数</div>
                </div>
                <div class="stat-card">
                    <div class="value">4</div>
                    <div class="label">最大连接度</div>
                </div>
                <div class="stat-card">
                    <div class="value">172</div>
                    <div class="label">覆盖影像数</div>
                </div>
            </div>

            <div class="highlight-box">
                <strong>核心发现：</strong>参考数据中100%的稠密像对来自三角形边，且97.3%被排除的边是其所在三角形中共视性最低的边。
            </div>
        </div>

        <!-- 输入输出 -->
        <div class="card">
            <h2>2. 输入与输出</h2>

            <div class="two-column">
                <div>
                    <h3>输入数据</h3>
                    <ul>
                        <li><strong>影像集：</strong>带有已知相机位姿的影像</li>
                        <li><strong>共视性数据：</strong>从连接点提取的影像对共享点数</li>
                        <li><strong>XML文件：</strong>包含Photo、Pose、TiePoint等信息</li>
                    </ul>
                </div>
                <div>
                    <h3>输出数据（三段式格式）</h3>
                    <ul>
                        <li><strong>Section 1：</strong>稠密匹配像对 (Dense Pairs)</li>
                        <li><strong>Section 2：</strong>优化像对 (Refine Pairs)</li>
                        <li><strong>Section 3：</strong>三角形约束 (Triplets)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 核心指标 -->
        <div class="card">
            <h2>3. 核心评价指标</h2>

            <table>
                <thead>
                    <tr>
                        <th>指标名称</th>
                        <th>定义</th>
                        <th>作用</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>共视性计数 (Covisibility)</strong></td>
                        <td>两幅影像共享的连接点数量</td>
                        <td>衡量影像重叠程度，数值越高匹配越可靠</td>
                    </tr>
                    <tr>
                        <td><strong>影像内排名 (Per-image Rank)</strong></td>
                        <td>像对在某影像邻居列表中的排名（按共视性排序）</td>
                        <td>反映像对对于单个影像的重要程度</td>
                    </tr>
                    <tr>
                        <td><strong>最小排名 (min_rank)</strong></td>
                        <td>min(rankA, rankB)</td>
                        <td>至少有一个影像高度偏好此像对</td>
                    </tr>
                    <tr>
                        <td><strong>最大排名 (max_rank)</strong></td>
                        <td>max(rankA, rankB)</td>
                        <td>衡量双向偏好的均衡程度</td>
                    </tr>
                    <tr>
                        <td><strong>ID跨度 (ID Span)</strong></td>
                        <td>|photoB - photoA|</td>
                        <td>识别"桥接"像对，连接远距离影像</td>
                    </tr>
                </tbody>
            </table>

            <div class="formula">
                <strong>排序准则：</strong> (min_rank, max_rank, -covisibility) — 升序、升序、降序
            </div>

            <div class="highlight-box">
                <strong>排序逻辑：</strong>优先选择被双方影像都高度偏好的像对。例如，排名为(1,2)的像对优于排名为(0,5)的像对，因为前者是"互相偏好"的关系。
            </div>
        </div>

        <!-- 算法流程 -->
        <div class="card">
            <h2>4. 算法流程</h2>

            <div class="flowchart">
                <div class="flow-step">
                    <h4>Step 1: 数据预处理</h4>
                    <p>解析XML，提取共视性数据，排除问题影像</p>
                    <span class="tag primary">排除影像: 2074, 2216, 2271</span>
                </div>

                <div class="flow-step">
                    <h4>Step 2: 计算排名</h4>
                    <p>为每个像对计算在两个影像中的排名</p>
                    <span class="tag primary">rankA, rankB, min_rank, max_rank</span>
                </div>

                <div class="flow-step">
                    <h4>Step 3: 候选排序</h4>
                    <p>按 (min_rank, max_rank, -covis) 排序</p>
                </div>

                <div class="flow-step highlight">
                    <h4>Step 4: 桥接像对优先选择</h4>
                    <p>优先选择ID跨度 > 400的远距离像对</p>
                    <span class="tag warning">目标: 约20%的像对</span>
                </div>

                <div class="flow-step">
                    <h4>Step 5: 多轮填充选择</h4>
                    <p>Pass 1: 双方度数=0 → Pass 2: 单方度数=0 → Pass 3: 填充剩余</p>
                </div>

                <div class="flow-step">
                    <h4>Step 6: 生成三角形和优化像对</h4>
                    <p>从稠密像对构建三角形，扩展生成优化像对</p>
                </div>
            </div>
        </div>

        <!-- 选择策略详解 -->
        <div class="card">
            <h2>5. 选择策略详解</h2>

            <h3>5.1 桥接像对选择 (Phase 0)</h3>
            <div class="highlight-box warning">
                <strong>目的：</strong>确保图的连通性，连接远距离影像区域
            </div>
            <ul>
                <li><strong>桥接阈值：</strong>ID跨度 > 400</li>
                <li><strong>桥接目标：</strong>总像对数的20%（约39-40对）</li>
                <li><strong>排序方式：</strong>按min_rank升序，共视性降序</li>
                <li><strong>约束条件：</strong>每个影像最大连接度为4</li>
            </ul>

            <div class="code-block">
<span class="comment">// 桥接像对选择伪代码</span>
<span class="keyword">for</span> bridge_pair <span class="keyword">in</span> sorted_bridges:
    <span class="keyword">if</span> selected_count >= bridge_target:
        <span class="keyword">break</span>
    <span class="keyword">if</span> degree[A] < <span class="number">4</span> <span class="keyword">and</span> degree[B] < <span class="number">4</span>:
        select(bridge_pair)
        degree[A]++
        degree[B]++
            </div>

            <h3>5.2 多轮填充选择 (Phase 1-3)</h3>

            <table>
                <thead>
                    <tr>
                        <th>阶段</th>
                        <th>条件</th>
                        <th>目的</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Pass 1</strong></td>
                        <td>degree[A] == 0 AND degree[B] == 0</td>
                        <td>覆盖孤立影像对，建立初始连接</td>
                    </tr>
                    <tr>
                        <td><strong>Pass 2</strong></td>
                        <td>degree[A] == 0 OR degree[B] == 0</td>
                        <td>扩展覆盖范围，连接未覆盖影像</td>
                    </tr>
                    <tr>
                        <td><strong>Pass 3</strong></td>
                        <td>degree[A] < 4 AND degree[B] < 4</td>
                        <td>填充剩余配额，增加冗余连接</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 参数配置 -->
        <div class="card">
            <h2>6. 参数配置</h2>

            <table>
                <thead>
                    <tr>
                        <th>参数</th>
                        <th>值</th>
                        <th>说明</th>
                        <th>调优建议</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>targetPairs</code></td>
                        <td>198</td>
                        <td>目标稠密像对数量</td>
                        <td>根据影像数量调整，通常为影像数×1.1-1.2</td>
                    </tr>
                    <tr>
                        <td><code>maxDegree</code></td>
                        <td>4</td>
                        <td>每个影像的最大连接数</td>
                        <td>增大可提高冗余，但可能降低效率</td>
                    </tr>
                    <tr>
                        <td><code>bridgeThreshold</code></td>
                        <td>400</td>
                        <td>桥接像对的ID跨度阈值</td>
                        <td>根据ID分布调整，通常为最大ID的15-25%</td>
                    </tr>
                    <tr>
                        <td><code>bridgeRatio</code></td>
                        <td>0.20</td>
                        <td>桥接像对占比</td>
                        <td>连通性差时可增大到0.25-0.30</td>
                    </tr>
                    <tr>
                        <td><code>refineExpansion</code></td>
                        <td>1.02</td>
                        <td>优化像对扩展系数</td>
                        <td>Refine = Dense × 1.02</td>
                    </tr>
                </tbody>
            </table>

            <div class="highlight-box">
                <strong>排除影像：</strong>
                <span class="tag warning">2074</span>
                <span class="tag warning">2216</span>
                <span class="tag warning">2271</span>
                <br><br>
                这些影像在参考数据中从未出现，可能存在质量问题或共视性不足。
            </div>
        </div>

        <!-- 性能对比 -->
        <div class="card">
            <h2>7. 性能对比</h2>

            <h3>算法演进</h3>
            <table>
                <thead>
                    <tr>
                        <th>算法版本</th>
                        <th>匹配率</th>
                        <th>改进</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>简单共视性排序</td>
                        <td>~60%</td>
                        <td>基准</td>
                    </tr>
                    <tr>
                        <td>排名优先选择</td>
                        <td>75.8%</td>
                        <td>+15.8%</td>
                    </tr>
                    <tr>
                        <td><strong>+ 桥接像对优先</strong></td>
                        <td><strong>81.3%</strong></td>
                        <td><strong>+5.5%</strong></td>
                    </tr>
                </tbody>
            </table>

            <h3>当前性能指标</h3>
            <div class="metric-comparison">
                <div class="metric-item">
                    <div>精确率 (Precision)</div>
                    <div class="after">81.3%</div>
                    <div class="progress-bar">
                        <div class="fill" style="width: 81.3%">81.3%</div>
                    </div>
                </div>
                <div class="metric-item">
                    <div>召回率 (Recall)</div>
                    <div class="after">81.3%</div>
                    <div class="progress-bar">
                        <div class="fill" style="width: 81.3%">81.3%</div>
                    </div>
                </div>
            </div>

            <h3>ID跨度分布对比</h3>
            <table>
                <thead>
                    <tr>
                        <th>数据集</th>
                        <th>平均ID跨度</th>
                        <th>评价</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>参考数据</td>
                        <td>207</td>
                        <td><span class="tag success">目标值</span></td>
                    </tr>
                    <tr>
                        <td>无桥接优化</td>
                        <td>98</td>
                        <td><span class="tag warning">偏低</span></td>
                    </tr>
                    <tr>
                        <td>有桥接优化</td>
                        <td>301</td>
                        <td><span class="tag primary">接近目标</span></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 数据结构 -->
        <div class="card">
            <h2>8. 核心数据结构</h2>

            <div class="code-block">
<span class="comment">// 带排名信息的像对结构</span>
<span class="keyword">struct</span> PairWithRanks {
    <span class="keyword">int</span> photoA, photoB;      <span class="comment">// 影像ID (已排序: A < B)</span>
    <span class="keyword">int</span> covisCount;          <span class="comment">// 共享连接点数量</span>
    <span class="keyword">int</span> rankA, rankB;        <span class="comment">// 在各影像中的排名</span>
    <span class="keyword">int</span> minRank, maxRank;    <span class="comment">// 排名的最小/最大值</span>
    <span class="keyword">int</span> idSpan;              <span class="comment">// |B - A| ID跨度</span>
};

<span class="comment">// 选择结果结构</span>
<span class="keyword">struct</span> PairSelectionResult {
    vector&lt;pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;&gt; densePairs;   <span class="comment">// Section 1: 稠密像对</span>
    vector&lt;pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;&gt; refinePairs;  <span class="comment">// Section 2: 优化像对</span>
    vector&lt;Triplet&gt; triplets;             <span class="comment">// Section 3: 三角形</span>
};
            </div>
        </div>

        <!-- 分析发现 -->
        <div class="card">
            <h2>9. 关键分析发现</h2>

            <div class="two-column">
                <div>
                    <h3>三角形-像对关系</h3>
                    <ul>
                        <li>111个三角形产生309条边</li>
                        <li>198条边被选为稠密像对</li>
                        <li>111条边被排除</li>
                        <li><strong>97.3%</strong>被排除的边是三角形中共视性最低的边</li>
                    </ul>
                </div>
                <div>
                    <h3>度数分布</h3>
                    <table>
                        <tr><th>度数</th><th>参考</th><th>生成</th></tr>
                        <tr><td>1</td><td>21</td><td>~20</td></tr>
                        <tr><td>2</td><td>87</td><td>~85</td></tr>
                        <tr><td>3</td><td>55</td><td>~55</td></tr>
                        <tr><td>4</td><td>9</td><td>~12</td></tr>
                    </table>
                </div>
            </div>

            <div class="highlight-box success">
                <strong>关键洞察：</strong>参考数据的选择策略是先选择高质量三角形，然后从每个三角形中移除最弱的边（共视性最低），保留两条较强的边作为稠密像对。
            </div>
        </div>

        <!-- 限制与改进 -->
        <div class="card">
            <h2>10. 限制与未来改进</h2>

            <h3>当前限制</h3>
            <div class="highlight-box warning">
                <strong>90%目标难以达成：</strong>在不知道参考数据的情况下，盲选算法的上限约为82%。Python原型通过迭代交换优化达到100%，但这需要在选择时访问参考数据。
            </div>

            <ul>
                <li>参数针对数据集1优化，其他数据集可能需要调整</li>
                <li>排除影像列表是硬编码的</li>
                <li>未利用几何特征（收敛角、基线等）</li>
            </ul>

            <h3>改进方向</h3>
            <ol>
                <li><strong>自适应参数：</strong>根据数据特征自动计算桥接阈值和目标数量</li>
                <li><strong>几何约束：</strong>加入收敛角、基线/深度比等几何特征</li>
                <li><strong>图优化：</strong>最小生成树变体，确保最优连通性</li>
                <li><strong>机器学习：</strong>训练模型预测参考选择模式</li>
            </ol>
        </div>

        <!-- 文件参考 -->
        <div class="card">
            <h2>11. 相关文件</h2>

            <table>
                <thead>
                    <tr>
                        <th>文件</th>
                        <th>说明</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>Apps/PairSelector/main.cpp</code></td>
                        <td>C++实现主文件</td>
                    </tr>
                    <tr>
                        <td><code>test_advanced_selection.py</code></td>
                        <td>Python原型算法</td>
                    </tr>
                    <tr>
                        <td><code>analyze_missed_pairs.py</code></td>
                        <td>未命中像对分析</td>
                    </tr>
                    <tr>
                        <td><code>analyze_triplet_criterion.py</code></td>
                        <td>三角形选择标准分析</td>
                    </tr>
                    <tr>
                        <td><code>test_bridge_selection.py</code></td>
                        <td>桥接像对影响研究</td>
                    </tr>
                    <tr>
                        <td><code>ALGORITHM_DESIGN.md</code></td>
                        <td>Markdown格式设计文档</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <footer>
        <p>Pair Selection Algorithm Documentation</p>
        <p>Generated: <script>document.write(new Date().toLocaleDateString())</script></p>
    </footer>
</body>
</html>
